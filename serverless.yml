service: stlog-notification-service
custom:
  serverless-offline:
    useChildProcesses: true
  customDomain:
    domainName: "hedwig.freshturf.io"
    basePath: ${self:provider.stage} # Use stage as the basePath to have /dev and /prod URL
    stage: ${self:provider.stage}
    createRoute53Record: false
    certificateName: "*.freshturf.io"
    endpointType: regional
provider:
  name: aws
  iamRoleStatements:
    - Effect: "Allow"
      Action:
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource:
        - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.AWS_DYNAMO_DB_TABLE_BALANCE}"
        - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.AWS_DYNAMO_DB_TABLE_SMS_TOPUPS}"
        - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.AWS_DYNAMO_DB_TABLE_EMAIL_TOPUPS}"
  runtime: nodejs12.x
  apiGateway:
    binaryMediaTypes:
      - "multipart/form-data"
  stage: ${opt:stage, 'dev'}
  region: ap-southeast-1
  memorySize: 128
  timeout: 30
  environment:
    NODE_ENV: dev
    AWS_SIGNED_URL_EXPIRES: "900"
    APP_AWS_REGION: ap-southeast-1
    AWS_S3_MAX_KEYS: 100 # max number of object keys to be returned
    AWS_DYNAMO_DB_TABLE_BALANCE: ${opt:stage, self:provider.stage, 'dev'}-balance
    AWS_DYNAMO_DB_TABLE_SMS_TOPUPS: ${opt:stage, self:provider.stage, 'dev'}-sms-topups
    AWS_DYNAMO_DB_TABLE_EMAIL_TOPUPS: ${opt:stage, self:provider.stage, 'dev'}-email-topups
    SMS_ENABLED: true #Disable so sms is not actually sent but API call still works
    # Twilio
    TWILIO_ACCOUNT_SID: ${ssm:/stlog-notification-service/TWILIO_ACCOUNT_SID~true}
    TWILIO_AUTH_TOKEN: ${ssm:/stlog-notification-service/TWILIO_AUTH_TOKEN~true}
    # Send Grid - ATS
    SEND_GRID_ATS_API_KEY_ID: ${ssm:/stlog-notification-service/SEND_GRID_ATS_API_KEY_ID~true}
    SEND_GRID_ATS_API_KEY_SECRET: ${ssm:/stlog-notification-service/SEND_GRID_ATS_API_KEY_SECRET~true}
    # Send Grid - Emart
    SEND_GRID_EMART_API_KEY_ID: ${ssm:/stlog-notification-service/SEND_GRID_EMART_API_KEY_ID~true}
    SEND_GRID_EMART_API_KEY_SECRET: ${ssm:/stlog-notification-service/SEND_GRID_EMART_API_KEY_SECRET~true}
package:
  exclude:
    - src/**
    - .env
    # - node_modules/**
plugins:
  - serverless-offline
  - serverless-domain-manager
functions:
  app:
    handler: dist/bin/www.handler
    events:
      - http: ANY /
      - http: "ANY {proxy+}"
